<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        #status { margin-top: 10px; font-weight: bold; }
        .success { color: green; }
        .error { color: red; }
    </style>
    <script>
        document.addEventListener("DOMContentLoaded", async function () {
            const response = await fetch("/check-auth");
            const data = await response.json();

            if (!data.authenticated) {
                window.location.href = "/login"; // Redirect if not authenticated
            }
        });
    </script>
</head>
<body>
    <h2>GPS Tracker Dashboard</h2>

    <label>Phone IP:</label>
    <input type="text" id="phone-ip" placeholder="Enter phone IP">
    <label>Port (Optional):</label>
    <input type="text" id="phone-port" placeholder="Default: 11123">
    <button onclick="startTracking()">Connect</button>

    <p id="status">Status: Not Connected</p>
    <p>Connection Time: <span id="time-count">0</span> seconds</p>

    <h3>GPS Data</h3>
    <p>Latitude: <span id="lat">-</span></p>
    <p>Longitude: <span id="lon">-</span></p>
    <p>Total Distance: <span id="distance">0</span> km</p>
    <button onclick="goToWeeklyReport()">View Weekly Report</button>
    <script>
        let trackingInterval, connectionTime = 0;
        let userId = localStorage.getItem("userId") || 1; // Default to user 1 if not found

        function convertToDecimal(value, direction) {
            // Example: 1106.41794 -> 11 degrees, 06.41794 minutes
            let degrees = parseInt(value.slice(0, -7));  // Get first part as degrees
            let minutes = parseFloat(value.slice(-7));   // Get remaining as minutes
            let decimal = degrees + (minutes / 60);

            // Handle South (S) and West (W) coordinates as negative
            if (direction === "S" || direction === "W") {
                decimal = -decimal;
            }

            return decimal;
        }
        
    
        async function fetchGPSData(ip, port) {
            try {
                const url = `http://localhost:89/fetch-gps?ip=${ip}&port=${port || 11123}`;
                const response = await fetch(url);
                const text = await response.text();
    
                const gpsParts = text.split(",");
                if (gpsParts[0] !== "$GPRMC") {
                    throw new Error("Invalid GPS data format");
                }

                // Extract latitude & longitude
                const rawLat = gpsParts[3];
                const rawLon = gpsParts[5];
                const latDirection = gpsParts[4];
                const lonDirection = gpsParts[6];

                // Convert to decimal format
                const lat = convertToDecimal(rawLat, latDirection);
                const lon = convertToDecimal(rawLon, lonDirection);

                document.getElementById("lat").innerText = lat.toFixed(6);
                document.getElementById("lon").innerText = lon.toFixed(6);
                
                // Send data to server
                const serverResponse = await fetch("http://localhost:89/update-location", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ userId, lat, lon })
                });
                const result = await serverResponse.json();
                
                document.getElementById("distance").innerText = result.distance.toFixed(3);
                document.getElementById("status").innerText = "Connected";
                document.getElementById("status").className = "success";
    
            } catch (error) {
                console.error("GPS Fetch Error:", error);
                document.getElementById("status").innerText = "Connection Failed";
                document.getElementById("status").className = "error";
                clearInterval(trackingInterval);
            }
        }
    
        function startTracking() {
            const ip = document.getElementById("phone-ip").value;
            const port = document.getElementById("phone-port").value || "11123";
    
            if (!ip) {
                alert("Please enter a phone IP");
                return;
            }
    
            connectionTime = 0;
            document.getElementById("status").innerText = "Connecting...";
            document.getElementById("status").className = "";
    
            trackingInterval = setInterval(() => {
                fetchGPSData(ip, port);
                document.getElementById("time-count").innerText = ++connectionTime;
            }, 1000);
        }
        function goToWeeklyReport() {
            fetch("/check-auth")
                .then(response => response.json())
                .then(data => {
                    if (data.authenticated) {
                        window.location.href = "/weekly-report"; 
                    } else {
                        alert("You must be logged in to access the weekly report.");
                        window.location.href = "/login";  
                    }
                })
                .catch(error => {
                    console.error("Auth check failed:", error);
                    alert("Error checking authentication. Please try again.");
                });
        }
    </script>
    
</body>
</html>